<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Heart Leaf Blooms</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap');

        :root {
            --primary: #2d6a4f;
            --bg: #f7fff7;
            --card-bg: #fff;
            --text: #333;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            margin-bottom: 40px;
            font-size: 1.5rem;
        }

        .sidebar button {
            background: none;
            border: none;
            color: white;
            text-align: left;
            padding: 15px;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 8px;
            transition: 0.3s;
        }

        .sidebar button:hover,
        .sidebar button.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            padding: 40px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
            color: var(--primary);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .card h3 {
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .pending {
            background: #ffeeba;
            color: #856404;
        }

        .approved {
            background: #d4edda;
            color: #155724;
        }

        .shipped {
            background: #cce5ff;
            color: #004085;
        }

        .completed {
            background: #d4edda;
            color: #155724;
        }

        .cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modal for Category */
        #catModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>Admin Panel</h2>
        <button onclick="showSection('home')" id="btn-home" class="active">Home</button>
        <button onclick="showSection('categories')" id="btn-categories">Categories</button>
        <button onclick="showSection('my-products')" id="btn-my-products">My Products</button>
        <button onclick="showSection('orders')" id="btn-orders">Orders</button>
        <button onclick="showSection('inventory')" id="btn-inventory">Inventory</button>
        <button onclick="showSection('users')" id="btn-users">Users</button>
        <button onclick="showSection('reviews')" id="btn-reviews">Reviews</button>
        <button onclick="logout()" style="margin-top: auto;">Logout</button>
    </div>

    <div class="main-content">

        <!-- Home Section (Dashboard Stats) -->
        <div id="section-home">
            <div class="header">
                <h1>Dashboard Overview</h1>
            </div>

            <div class="card-grid" style="margin-bottom: 40px;">
                <div class="card">
                    <h3>Orders Today</h3>
                    <p style="font-size: 2.5rem; font-weight: bold; margin: 10px 0; color: var(--primary);"
                        id="stat-orders-today">0</p>
                    <small style="color: gray;">Orders placed today</small>
                </div>
                <div class="card">
                    <h3>Total Revenue</h3>
                    <p style="font-size: 2.5rem; font-weight: bold; margin: 10px 0; color: var(--primary);"
                        id="stat-revenue">₹0</p>
                    <small style="color: gray;">Total revenue credited</small>
                </div>
                <div class="card">
                    <h3>Total Inventory</h3>
                    <p style="font-size: 2.5rem; font-weight: bold; margin: 10px 0; color: var(--primary);"
                        id="stat-inventory">0</p>
                    <small style="color: gray;">Active items (Admin + Vendor)</small>
                </div>
                <div class="card">
                    <h3>Total Users</h3>
                    <p style="font-size: 2.5rem; font-weight: bold; margin: 10px 0; color: var(--primary);"
                        id="stat-users">0</p>
                    <small style="color: gray;">Registered Users</small>
                </div>
            </div>

            <div class="header">
                <h2>Recent Orders</h2>
                <button onclick="showSection('orders')"
                    style="background:none; border:none; color:var(--primary); cursor:pointer; font-weight:600;">View
                    All &rarr;</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Total</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersList"></tbody>
            </table>
        </div>

        <div id="section-categories" style="display:none">
            <div class="header">
                <h1>Category Management</h1>
                <button onclick="openCatModal()"
                    style="padding: 10px 20px; background: #2d6a4f; color: white; border: none; border-radius: 8px; cursor: pointer;">+
                    Add Category</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoryList"></tbody>
            </table>
        </div>

        <div id="section-orders" style="display:none">
            <div class="header">
                <h1>Order Management</h1>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
        </div>

        <div id="section-my-products" style="display:none">
            <div class="header">
                <h1>My Products (Admin)</h1>
                <button onclick="openAdminProductModal()"
                    style="padding: 10px 20px; background: #2d6a4f; color: white; border: none; border-radius: 8px; cursor: pointer;">+
                    Add Product</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Featured</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="myProductList"></tbody>
            </table>
        </div>

        <div id="section-inventory" style="display:none">
            <div class="header">
                <h1>Inventory</h1>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Owner</th>
                        <th>Price</th>
                        <th>Stock Status</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="inventoryList"></tbody>
            </table>
        </div>

        <div id="section-users" style="display:none">
            <div class="header">
                <h1>Registered Users</h1>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Contact</th>
                        <th>Address</th>
                    </tr>
                </thead>
                <tbody id="userList"></tbody>
            </table>
        </div>

        <div id="section-reviews" style="display:none">
            <div class="header">
                <h1>Product Reviews</h1>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>User</th>
                        <th>Rating</th>
                        <th>Review</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="reviewList"></tbody>
            </table>
        </div>

        <!-- Product Modal -->


        <!-- Admin Product Modal -->
        <div id="adminProductModal"
            style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:200;">
            <div class="modal-body" style="width: 500px; max-height: 90vh; overflow-y: auto;">
                <h3>Add Product (Admin)</h3>
                <form id="adminProductForm" onsubmit="submitAdminProduct(event)"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <input type="hidden" name="id" id="adminProductId"> <!-- For updates -->

                    <div style="grid-column: 1 / -1;">
                        <label>Category</label>
                        <select name="category_id" id="adminProductCategory" required class="input-field"></select>
                    </div>

                    <div>
                        <label>Product Name</label>
                        <input type="text" name="product_name" required>
                    </div>

                    <div>
                        <label>Title</label>
                        <input type="text" name="product_title" required>
                    </div>

                    <div style="grid-column: 1 / -1;">
                        <label>Description</label>
                        <textarea name="product_description" required></textarea>
                    </div>

                    <div>
                        <label>Price</label>
                        <input type="number" name="product_price" required>
                    </div>

                    <div>
                        <label>Discount Price</label>
                        <input type="number" name="discount_price">
                    </div>

                    <div>
                        <label>Stock</label>
                        <input type="number" name="stock" value="0">
                    </div>

                    <div>
                        <label>Product Guide</label>
                        <input type="text" name="product_guide" placeholder="Optional URL or text">
                    </div>

                    <div>
                        <label>Status</label>
                        <select name="status">
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                            <option value="DRAFT">Draft</option>
                            <option value="OUT_OF_STOCK">Out of Stock</option>
                        </select>
                    </div>

                    <div>
                        <label>Featured</label>
                        <select name="is_featured">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>

                    <div style="grid-column: 1 / -1;">
                        <label>Images</label>
                        <input type="file" id="adminProductImages" multiple accept="image/*">
                    </div>

                    <div style="grid-column: 1 / -1; display:flex; gap:10px;">
                        <button type="submit" id="btnSaveAdminProduct"
                            style="width: 100%; padding: 10px; background: #2d6a4f; color: white; border: none; border-radius: 8px; cursor: pointer;">Save
                            Product</button>
                        <button type="button" onclick="closeAdminProductModal()"
                            style="width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="catModal">
            <div class="modal-body">
                <h3>Add Category</h3>
                <input type="text" id="catName" placeholder="Category Name">
                <textarea id="catDesc" placeholder="Description"></textarea>
                <input type="text" id="catIcon" placeholder="Icon URL">
                <button onclick="createCategory()"
                    style="padding: 10px; width: 100%; background: #2d6a4f; color: white; border: none; border-radius: 8px; cursor: pointer;">Save</button>
                <button onclick="closeCatModal()"
                    style="padding: 10px; width: 100%; background: #eee; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">Cancel</button>
            </div>
        </div>

        <!-- Order Detail Modal -->
        <div id="orderDetailModal"
            style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:200;">
            <div class="modal-body" style="width: 600px; max-height: 90vh; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">Order Details</h3>
                    <button onclick="closeOrderDetailModal()"
                        style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>

                <div id="orderDetailContent"></div>
            </div>
        </div>

        <script>
            // Use existing vendor logic, extend with categories

            const API_BASE_URL = window.location.hostname === '127.0.0.1' ? 'http://127.0.0.1:7071' : 'http://localhost:7071';
            let allOrders = [];

            function showSection(id) {
                document.getElementById('section-home').style.display = id === 'home' ? 'block' : 'none';
                document.getElementById('section-categories').style.display = id === 'categories' ? 'block' : 'none';
                document.getElementById('section-orders').style.display = id === 'orders' ? 'block' : 'none';
                document.getElementById('section-my-products').style.display = id === 'my-products' ? 'block' : 'none';
                document.getElementById('section-inventory').style.display = id === 'inventory' ? 'block' : 'none';
                document.getElementById('section-users').style.display = id === 'users' ? 'block' : 'none';
                document.getElementById('section-reviews').style.display = id === 'reviews' ? 'block' : 'none';

                document.getElementById('btn-home').classList.toggle('active', id === 'home');
                document.getElementById('btn-categories').classList.toggle('active', id === 'categories');
                document.getElementById('btn-orders').classList.toggle('active', id === 'orders');
                document.getElementById('btn-my-products').classList.toggle('active', id === 'my-products');
                document.getElementById('btn-inventory').classList.toggle('active', id === 'inventory');
                document.getElementById('btn-users').classList.toggle('active', id === 'users');
                document.getElementById('btn-reviews').classList.toggle('active', id === 'reviews');

                if (id === 'home') loadDashboardStats();
                if (id === 'categories') loadCategories();
                if (id === 'orders') loadOrders();
                if (id === 'my-products') loadMyProducts(); // Admin products
                if (id === 'inventory') loadInventory();
                if (id === 'users') loadUsers();
                if (id === 'reviews') loadReviews();
            }

            async function loadDashboardStats() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/dashboard-stats`, { credentials: 'include' });
                    const data = await res.json();

                    document.getElementById('stat-orders-today').innerText = data.ordersToday || 0;
                    document.getElementById('stat-revenue').innerText = '₹' + (data.totalRevenue || 0);
                    document.getElementById('stat-inventory').innerText = data.totalInventory || 0;
                    document.getElementById('stat-users').innerText = data.totalUsers || 0;

                    const tbody = document.getElementById('recentOrdersList');
                    tbody.innerHTML = '';
                    if (data.recentOrders && data.recentOrders.length > 0) {
                        data.recentOrders.forEach(o => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${o.order_id.substring(0, 8)}...</td>
                                <td>${o.user ? o.user.username : 'Unknown'}</td>
                                <td>₹${o.total_amount}</td>
                                <td>${new Date(o.createdAt).toLocaleDateString()}</td>
                                <td><span class="status-badge ${o.order_status}">${o.order_status}</span></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No recent orders</td></tr>';
                    }

                } catch (e) {
                    console.error("Error loading stats:", e);
                }
            }

            async function loadCategories() {
                try {
                    const res = await fetch(`${API_BASE_URL}/category`, { credentials: 'include' });
                    const cats = await res.json();
                    const tbody = document.getElementById('categoryList');
                    tbody.innerHTML = '';

                    cats.forEach(c => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${c.category_id}</td>
                        <td>${c.category_name}</td>
                        <td>${c.category_description}</td>
                        <td>
                             <button onclick="deleteCategory(${c.category_id})">Delete</button>
                        </td>
                    `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            async function loadOrders() {
                try {
                    const res = await fetch(`${API_BASE_URL}/order/admin`, { credentials: 'include' });
                    allOrders = await res.json();
                    const tbody = document.getElementById('orderList');
                    tbody.innerHTML = '';

                    allOrders.forEach((o, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${o.order_id.substring(0, 8)}...</td>
                        <td>${o.user ? o.user.username : 'Unknown'}</td>
                        <td>₹${o.total_amount}</td>
                        <td><span class="status-badge ${o.order_status}">${o.order_status}</span></td>
                        <td>
                             <button onclick="openOrderDetailModal(${index})" style="background:#007bff; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">View</button>
                             <button onclick="updateOrderStatus('${o.order_id}', 'approved')">Approve</button>
                             <button onclick="updateOrderStatus('${o.order_id}', 'shipped')">Ship</button>
                             <button onclick="updateOrderStatus('${o.order_id}', 'completed')">Complete</button>
                        </td>
                    `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            function openOrderDetailModal(index) {
                const order = allOrders[index];
                if (!order) return;

                const modal = document.getElementById('orderDetailModal');
                const content = document.getElementById('orderDetailContent');

                // Determine Address
                let addressHtml = '<p>No address found.</p>';
                if (order.shippingAddress) {
                    addressHtml = `
                        <p><strong>Shipping Address:</strong><br>
                        ${order.shippingAddress.address}, ${order.shippingAddress.city}, ${order.shippingAddress.state} - ${order.shippingAddress.pincode}<br>
                        <strong>Phone:</strong> ${order.shippingAddress.phone || 'N/A'}</p>
                    `;
                } else if (order.user && order.user.addresses && order.user.addresses.length > 0) {
                    // Fallback to first user address
                    const addr = order.user.addresses[0];
                    addressHtml = `
                        <p><strong>User Address (Fallback):</strong><br>
                        ${addr.address}, ${addr.city}, ${addr.state} - ${addr.pincode}</p>
                    `;
                }

                // Order Items
                let itemsHtml = `
                    <table style="width:100%; margin-top:10px;">
                        <thead>
                            <tr style="background:#eee;">
                                <th style="padding:8px;">Product</th>
                                <th style="padding:8px;">Vendor</th>
                                <th style="padding:8px;">Qty</th>
                                <th style="padding:8px;">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                if (order.orderItems && order.orderItems.length > 0) {
                    order.orderItems.forEach(item => {
                        itemsHtml += `
                            <tr>
                                <td style="padding:8px;">
                                    ${item.product ? item.product.product_name : 'Unknown Product'}
                                    <br><small style="color:gray;">${item.product ? item.product.product_title : ''}</small>
                                </td>
                                <td style="padding:8px;">${item.vendor ? item.vendor.shopName : 'Admin'}</td>
                                <td style="padding:8px;">${item.quantity}</td>
                                <td style="padding:8px;">₹${item.price}</td>
                            </tr>
                        `;
                    });
                }
                itemsHtml += '</tbody></table>';

                content.innerHTML = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                        <div>
                            <p><strong>Order ID:</strong> ${order.order_id}</p>
                            <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${order.order_status}">${order.order_status}</span></p>
                        </div>
                        <div>
                            <p><strong>User:</strong> ${order.user ? order.user.username : 'Unknown'}</p>
                            <p><strong>Email:</strong> ${order.user ? order.user.user_email : 'Unknown'}</p>
                            <p><strong>Mobile:</strong> ${order.user ? (order.user.mobile_number || 'N/A') : 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px;">
                        ${addressHtml}
                    </div>

                    <h4>Order Items</h4>
                    ${itemsHtml}

                    <div style="text-align:right; margin-top:20px;">
                        <h3>Total: ₹${order.total_amount}</h3>
                    </div>
                `;

                modal.style.display = 'flex';
            }

            function closeOrderDetailModal() {
                document.getElementById('orderDetailModal').style.display = 'none';
            }

            async function updateOrderStatus(id, status) {
                try {
                    await fetch(`${API_BASE_URL}/order/admin/${id}`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    loadOrders(); // Reload to update list
                } catch (e) { console.error(e); }
            }

            function openCatModal() { document.getElementById('catModal').style.display = 'flex'; }
            function closeCatModal() { document.getElementById('catModal').style.display = 'none'; }

            async function createCategory() {
                const name = document.getElementById('catName').value;
                const desc = document.getElementById('catDesc').value;
                const icon = document.getElementById('catIcon').value;

                await fetch(`${API_BASE_URL}/category`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_name: name, category_description: desc, category_icon: icon })
                });
                closeCatModal();
                loadCategories();
            }

            async function deleteCategory(id) {
                if (confirm('Delete?')) {
                    await fetch(`${API_BASE_URL}/category/${id}`, { method: 'DELETE', credentials: 'include' });
                    loadCategories();
                }
            }

            async function logout() {
                try {
                    await fetch(`${API_BASE_URL}/admin/logout`, { method: 'POST' });
                    window.location.href = 'admin_login.html';
                } catch (e) {
                    window.location.href = 'admin_login.html';
                }
            }

            async function loadInventory() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/inventory`, { credentials: 'include' });
                    const items = await res.json();
                    const tbody = document.getElementById('inventoryList');
                    tbody.innerHTML = '';
                    items.forEach(i => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${i.name}</td>
                            <td>${i.owner_name} (${i.owner_type})</td>
                            <td>₹${i.price}</td>
                            <td>${i.stock !== null ? i.stock : '-'}</td>
                             <td><span class="status-badge ${i.inventory_status === 'In Stock' ? 'approved' : 'cancelled'}">${i.inventory_status}</span></td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (e) {
                    console.error(e);
                }
            }

            async function loadUsers() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/users`, { credentials: 'include' });
                    const users = await res.json();
                    const tbody = document.getElementById('userList');
                    tbody.innerHTML = '';
                    users.forEach(u => {
                        const addr = u.addresses && u.addresses.length > 0 ? `${u.addresses[0].city}, ${u.addresses[0].state}` : 'N/A';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${u.user_id.substring(0, 8)}...</td>
                            <td>${u.username}</td>
                            <td>${u.user_email}</td>
                            <td>${u.mobile_number || '-'}</td>
                            <td>${addr}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            async function loadReviews() {
                try {
                    const res = await fetch(`${API_BASE_URL}/review/admin/all`, { credentials: 'include' });
                    const reviews = await res.json();
                    const tbody = document.getElementById('reviewList');
                    tbody.innerHTML = '';
                    reviews.forEach(r => {
                        let prodName = 'Unknown';
                        if (r.product) prodName = r.product.product_name;
                        if (r.adminProduct) prodName = r.adminProduct.product_name;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${prodName}</td>
                            <td>${r.user ? r.user.username : 'Unknown'}</td>
                            <td>${r.rating} / 5</td>
                            <td>${r.review}</td>
                            <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }



            // --- Product Management (Admin Side) ---



            // --- Admin My Products Logic ---

            async function loadMyProducts() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/products`, { credentials: 'include' });
                    const products = await res.json();
                    const container = document.getElementById('myProductList');
                    container.innerHTML = '';

                    products.forEach(p => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${p.images && p.images.length > 0 ? p.images[0].small_url : ''}" 
                                     style="width:40px; height:40px; object-fit:cover; border-radius:4px; background:#eee;">
                                <div>
                                    <div style="font-weight:bold;">${p.product_name}</div>
                                    <small style="color:gray;">${p.product_title}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            ₹${p.product_price}
                            ${p.discount_price ? `<br><small style="text-decoration:line-through; color:gray">₹${p.discount_price}</small>` : ''}
                        </td>
                        <td>${p.stock}</td>
                        <td><span class="status-badge ${p.status === 'ACTIVE' ? 'approved' : 'pending'}">${p.status}</span></td>
                        <td>${p.is_featured ? '⭐' : '-'}</td>
                        <td>
                             <button onclick="editAdminProduct('${p.product_id}')">Edit</button>
                             <button onclick="deleteAdminProduct('${p.product_id}')" style="background: #e63946;">Delete</button>
                        </td>
                    `;
                        container.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            function openAdminProductModal(product = null) {
                document.getElementById('adminProductModal').style.display = 'flex';
                loadCategoriesForElement('adminProductCategory'); // Helper

                const form = document.getElementById('adminProductForm');
                form.reset();
                document.getElementById('adminProductId').value = '';

                if (product) {
                    document.getElementById('adminProductId').value = product.product_id;
                    form.product_name.value = product.product_name;
                    form.product_title.value = product.product_title;
                    form.product_description.value = product.product_description;
                    form.product_price.value = product.product_price;
                    if (product.discount_price) form.discount_price.value = product.discount_price;
                    if (product.stock) form.stock.value = product.stock;
                    if (product.product_guide) form.product_guide.value = product.product_guide;
                    form.is_featured.value = product.is_featured ? 'true' : 'false';
                    form.status.value = product.status || 'ACTIVE';
                    // Wait for categories to load then set value
                    setTimeout(() => {
                        if (product.category_id) form.category_id.value = product.category_id;
                    }, 500);
                }
            }

            function closeAdminProductModal() {
                document.getElementById('adminProductModal').style.display = 'none';
            }

            async function editAdminProduct(id) {
                // Fetch single product details to populate form
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/products/${id}`, { credentials: 'include' });
                    const product = await res.json();
                    openAdminProductModal(product);
                } catch (e) { console.error(e); }
            }

            async function deleteAdminProduct(id) {
                if (confirm('Are you sure needed to delete this product?')) {
                    await fetch(`${API_BASE_URL}/admin/products/${id}`, { method: 'DELETE', credentials: 'include' });
                    loadMyProducts();
                }
            }

            async function submitAdminProduct(e) {
                e.preventDefault();
                const btn = document.getElementById('btnSaveAdminProduct');
                btn.disabled = true;
                btn.innerText = 'Saving...';

                const form = document.getElementById('adminProductForm');
                const id = document.getElementById('adminProductId').value;
                const fileInput = document.getElementById('adminProductImages');
                const files = fileInput.files;

                let imageUrls = [];

                try {
                    // 1. Upload new images if any
                    if (files.length > 0) {
                        // Reuse existing image upload endpoint (Vendor/Product one - assuming it works for authenticated users)
                        // Or create a new one. Let's try the existing one first.
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const uploadData = new FormData();
                            uploadData.append('image', file);
                            const res = await fetch(`${API_BASE_URL}/product/upload-image`, {
                                method: 'POST', credentials: 'include', body: uploadData
                            });
                            const data = await res.json();
                            if (res.ok) {
                                imageUrls.push(data.data.large);
                                imageUrls.push(data.data.medium);
                                imageUrls.push(data.data.small);
                            }
                        }
                    }

                    // 2. Prepare Data
                    const payload = {
                        category_id: form.category_id.value,
                        product_name: form.product_name.value,
                        product_title: form.product_title.value,
                        product_description: form.product_description.value,
                        product_price: form.product_price.value,
                        discount_price: form.discount_price.value,
                        stock: form.stock.value,
                        product_guide: form.product_guide.value,
                        is_featured: form.is_featured.value === 'true',
                        status: form.status.value,
                        product_images: imageUrls.length > 0 ? imageUrls : undefined
                    };

                    let url = `${API_BASE_URL}/admin/products`;
                    let method = 'POST';
                    if (id) {
                        url += `/${id}`;
                        method = 'PUT';
                    }

                    const res = await fetch(url, {
                        method: method,
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        alert('Saved Successfully');
                        closeAdminProductModal();
                        loadMyProducts();
                    } else {
                        const err = await res.json();
                        alert('Error: ' + (err.error || err.message));
                    }

                } catch (err) {
                    console.error(err);
                    alert('Failed');
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'Save Product';
                }
            }

            async function loadInventory() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/inventory`, { credentials: 'include' });
                    const inventory = await res.json();
                    const tbody = document.getElementById('inventoryList');
                    tbody.innerHTML = '';

                    inventory.forEach(item => {
                        const tr = document.createElement('tr');

                        // Stock Status Badge Logic
                        let stockBadgeClass = 'pending'; // Default yellow
                        if (item.inventory_status === 'In Stock' || item.inventory_status === 'Available') {
                            stockBadgeClass = 'approved'; // Green
                        } else {
                            stockBadgeClass = 'pending'; // Use pending style for Out of Stock / Unavailable (or keep as is)
                            // Or custom class if defined
                        }
                        // We can just use the generic 'status-badge' classes defined in CSS: pending (yellow), approved (green)
                        let badgeColor = item.inventory_status.includes('In') || item.inventory_status === 'Available' ? 'approved' : 'pending';

                        tr.innerHTML = `
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${item.image || ''}" 
                                     style="width:40px; height:40px; object-fit:cover; border-radius:4px; background:#eee;">
                                <div>
                                    <div style="font-weight:bold;">${item.name}</div>
                                    <small style="color:gray;">${item.title}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${item.owner_name}</div>
                            <small style="color:gray;">${item.owner_type}</small>
                        </td>
                        <td>₹${item.price}</td>
                        <td>
                            ${item.stock !== null ? `<strong>${item.stock}</strong> units` : '-'}
                            <br>
                            <span class="status-badge ${badgeColor}">${item.inventory_status}</span>
                        </td>
                        <td>${item.status}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            async function loadCategoriesForElement(elementId) {
                try {
                    const res = await fetch(`${API_BASE_URL}/category`);
                    const cats = await res.json();
                    const select = document.getElementById(elementId);
                    select.innerHTML = '<option value="">Select Category</option>';
                    cats.forEach(c => {
                        select.innerHTML += `<option value="${c.category_id}">${c.category_name}</option>`;
                    });
                } catch (e) { console.error(e); }
            }

            // Init
            showSection('home');
        </script>
</body>

</html>